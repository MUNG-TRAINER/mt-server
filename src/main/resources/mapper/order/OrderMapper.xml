<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mungtrainer.mtserver.order.dao.OrderDAO">

    <!-- OrderMaster Result Map -->
    <resultMap id="orderMasterResultMap" type="com.mungtrainer.mtserver.order.entity.OrderMaster">
        <id property="orderId" column="order_id"/>
        <result property="merchantUid" column="merchant_uid"/>
        <result property="userId" column="user_id"/>
        <result property="orderStatus" column="order_status"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="paidAmount" column="paid_amount"/>
        <result property="paidAt" column="paid_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- OrderItem Result Map -->
    <resultMap id="orderItemResultMap" type="com.mungtrainer.mtserver.order.entity.OrderItem">
        <id property="orderItemId" column="order_item_id"/>
        <result property="orderId" column="order_id"/>
        <result property="applicationId" column="application_id"/>
        <result property="price" column="price"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 주문 생성 -->
    <insert id="insertOrder" parameterType="com.mungtrainer.mtserver.order.entity.OrderMaster"
            useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO order_master (
            merchant_uid,
            user_id,
            order_status,
            total_amount,
            paid_amount,
            order_name,
            created_by,
            updated_by,
            created_at,
            updated_at
        ) VALUES (
            #{merchantUid},
            #{userId},
            #{orderStatus},
            #{totalAmount},
            #{paidAmount},
            #{orderName},
            #{createdBy},
            #{updatedBy},
            NOW(),
            NOW()
        )
    </insert>

    <!--    주문 item 생성  -->
    <insert id="insertOrderItems">
        INSERT INTO order_item (
        order_id,
        application_id,
        price,
        created_by,
        updated_by,
        created_at,
        updated_at
        )
        SELECT
        #{orderId},
        tca.application_id,
        ts.price,
        #{userId},
        #{userId},
        NOW(),
        NOW()
        FROM training_course_application tca
        JOIN training_session ts
        ON ts.session_id = tca.session_id
        JOIN dog d
        ON d.dog_id = tca.dog_id
        WHERE
        d.user_id = #{userId}
          <if test="applicationIds != null and applicationIds.size() > 0">
            AND tca.application_id IN
            <foreach collection="applicationIds"
                     item="applicationId"
                     open="("
                     close=")"
                     separator=",">
                #{applicationId}
            </foreach>
          </if>
        AND tca.status = 'ACCEPT'
        AND ts.status = 'SCHEDULED'
        AND ts.is_deleted != 1
    </insert>


    <!-- 주문 상태 업데이트 -->
    <update id="updateOrderStatus" parameterType="com.mungtrainer.mtserver.order.entity.OrderMaster">
        UPDATE order_master
        SET order_status = #{orderStatus},
            paid_at = #{paidAt},
            updated_at = NOW()
        WHERE order_id = #{orderId}
    </update>

    <!-- 주문 조회 (by merchantUid) -->
    <select id="findByMerchantUid" parameterType="string" resultMap="orderMasterResultMap">
        SELECT * FROM order_master WHERE merchant_uid = #{merchantUid}
    </select>

    <!-- 주문 마스터 정보 업데이트 -->
    <update id="updateOrderMaster" parameterType="com.mungtrainer.mtserver.order.entity.OrderMaster">
        UPDATE order_master
        SET
            order_status = #{orderStatus},
            paid_amount = #{paidAmount},
            paid_at = #{paidAt},
            updated_at = NOW()
        WHERE order_id = #{orderId}
    </update>

    <!-- 주문 조회 (by orderId) -->
    <select id="findById" parameterType="long" resultMap="orderMasterResultMap">
        SELECT * FROM order_master WHERE order_id = #{orderId}
    </select>

</mapper>