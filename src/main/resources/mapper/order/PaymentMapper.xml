<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mungtrainer.mtserver.order.dao.PaymentDAO">

    <!-- Payment Result Map -->
    <resultMap id="paymentResultMap" type="com.mungtrainer.mtserver.order.entity.Payment">
        <id property="paymentId" column="payment_id"/>
        <result property="orderId" column="order_id"/>
        <result property="paymentKey" column="payment_key"/>
        <result property="method" column="method"/>
        <result property="amount" column="amount"/>
        <result property="paymentStatus" column="payment_status"/>
        <result property="merchantUid" column="merchant_uid"/>
        <result property="paidAt" column="paid_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedBy" column="updated_by"/>
    </resultMap>

    <!-- PaymentLog Result Map -->
    <resultMap id="paymentLogResultMap" type="com.mungtrainer.mtserver.order.entity.PaymentLog">
        <id property="logId" column="log_id"/>
        <result property="paymentId" column="payment_id"/>
        <result property="status" column="status"/>
        <result property="amount" column="amount"/>
        <result property="pgTid" column="pg_tid"/>
        <result property="merchantUid" column="merchant_uid"/>
        <result property="failureReason" column="failure_reason"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findOrderItemsByOrderId" resultType="com.mungtrainer.mtserver.order.entity.OrderItem">
        SELECT *
        FROM order_item
        WHERE order_id = #{orderId}
    </select>

    <select id="getCostByCourseIds"
            resultType="int">

        SELECT COALESCE(SUM(ts.price), 0)
        FROM training_session ts
        JOIN training_course_application tca
        ON tca.session_id = ts.session_id
        JOIN dog d
        ON d.dog_id = tca.dog_id
        JOIN training_course tc
        ON tc.course_id = ts.course_id
        WHERE 1 = 1
        AND tca.status = 'ACCEPT'
        AND d.user_id = #{userId}
        AND tc.status != 'CANCELED'
        AND tc.is_deleted != 1

        <if test="courseIds != null and courseIds.size() > 0">
            AND ts.course_id IN
            <foreach collection="courseIds"
                     item="courseId"
                     open="("
                     separator=","
                     close=")">
                #{courseId}
            </foreach>
        </if>

    </select>


    <!-- 결제 생성 -->
    <insert id="insertPayment" parameterType="com.mungtrainer.mtserver.order.entity.Payment"
            useGeneratedKeys="true" keyProperty="paymentId">
        INSERT INTO payment (
            order_id,
            payment_key,
            method,
            amount,
            payment_status,
            merchant_uid,
            paid_at,
            created_by,
            updated_by,
            created_at,
            updated_at
        ) VALUES (
            #{orderId},
            #{paymentKey},
            #{method},
            #{amount},
            #{paymentStatus},
            #{merchantUid},
            #{paidAt},
            #{createdBy},
            #{updatedBy},
                  NOW(),
                  NOW()
        )
    </insert>

    <!-- 결제 로그 생성 -->
    <insert id="insertPaymentLog" parameterType="com.mungtrainer.mtserver.order.entity.PaymentLog"
            useGeneratedKeys="true" keyProperty="logId">
        INSERT INTO payment_log (
            payment_id,
            status,
            amount,
            pg_tid,
            merchant_uid,
            failure_reason,
            created_at,
            updated_at
        ) VALUES (
            #{paymentId},
            #{status},
            #{amount},
            #{pgTid},
            #{merchantUid},
            #{failureReason},
            NOW(),
            NOW()
        )
    </insert>

    <!-- 결제 조회 (by paymentKey) -->
    <select id="findByPaymentKey" parameterType="string" resultMap="paymentResultMap">
        SELECT * FROM payment WHERE payment_key = #{paymentKey}
    </select>

    <!-- 결제 정보 업데이트 -->
    <update id="updatePayment" parameterType="com.mungtrainer.mtserver.order.entity.Payment">
        UPDATE payment
        SET
            payment_status = #{paymentStatus},
            updated_at = NOW()
        WHERE payment_id = #{paymentId}
    </update>

</mapper>