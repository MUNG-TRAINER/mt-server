<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mungtrainer.mtserver.training.dao.TrainingSessionDAO">

    <resultMap id="sessionResultMap" type="com.mungtrainer.mtserver.training.dto.response.TrainingSessionResponse">
        <id property="sessionId" column="session_id"/>
        <result property="sessionNo" column="session_no"/>
        <result property="sessionDate" column="session_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="locationDetail" column="location_detail"/>
        <result property="status" column="status"/>
        <result property="maxStudents" column="max_students"/>
        <result property="currentStudents" column="current_students"/>
        <result property="content" column="content"/>
        <result property="price" column="price"/>
    </resultMap>

    <!-- Result Map -->
    <resultMap id="trainingSessionResultMap" type="com.mungtrainer.mtserver.training.entity.TrainingSession">
        <id property="sessionId" column="session_id"/>
        <result property="courseId" column="course_id"/>
        <result property="sessionNo" column="session_no"/>
        <result property="sessionDate" column="session_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="locationDetail" column="location_detail"/>
        <result property="status" column="status"/>
        <result property="maxStudents" column="max_students"/>
        <result property="content" column="content"/>
        <result property="price" column="price"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 특정 코스의 세션 목록 조회 -->
    <select id="findSessionsByCourseId" parameterType="long" resultMap="sessionResultMap">
        SELECT
            ts.session_id,
            ts.session_no,
            ts.session_date,
            ts.start_time,
            ts.end_time,
            ts.location_detail,
            ts.status,
            ts.max_students,
            ts.content,
            ts.price,
            COALESCE(COUNT(tca.application_id), 0) AS current_students
        FROM training_session ts
        LEFT JOIN training_course_application tca
            ON ts.session_id = tca.session_id
            AND tca.is_deleted = 0
            AND tca.status != 'CANCELLED'
        WHERE ts.course_id = #{courseId}
          AND ts.is_deleted = 0
        GROUP BY ts.session_id
        ORDER BY ts.session_no ASC
    </select>

    <!-- 특정 세션 상세 조회 -->
    <select id="findSessionById" resultMap="sessionResultMap">
        SELECT
            ts.session_id,
            ts.session_no,
            ts.session_date,
            ts.start_time,
            ts.end_time,
            ts.location_detail,
            ts.status,
            ts.max_students,
            ts.content,
            ts.price,
            COALESCE(COUNT(tca.application_id), 0) AS current_students
        FROM training_session ts
        LEFT JOIN training_course_application tca
            ON ts.session_id = tca.session_id
            AND tca.is_deleted = 0
            AND tca.status != 'CANCELLED'
        WHERE ts.course_id = #{courseId}
          AND ts.session_id = #{sessionId}
          AND ts.is_deleted = 0
        GROUP BY ts.session_id
    </select>

    <!-- 세션이 해당 훈련사의 것인지 확인 -->
    <select id="isSessionOwnedByTrainer" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM training_session ts
            INNER JOIN training_course tc ON ts.course_id = tc.course_id
            WHERE ts.session_id = #{sessionId}
              AND tc.trainer_id = #{trainerId}
              AND ts.is_deleted = 0
              AND tc.is_deleted = 0
        )
    </select>

    <!-- 세션 정보 수정 -->
    <update id="updateSession">
        UPDATE training_session
        <set>
            <if test="request.sessionDate != null">
                session_date = #{request.sessionDate},
            </if>
            <if test="request.startTime != null">
                start_time = #{request.startTime},
            </if>
            <if test="request.endTime != null">
                end_time = #{request.endTime},
            </if>
            <if test="request.locationDetail != null and request.locationDetail != ''">
                location_detail = #{request.locationDetail},
            </if>
            <if test="request.status != null and request.status != ''">
                status = #{request.status},
            </if>
            <if test="request.maxStudents != null">
                max_students = #{request.maxStudents},
            </if>
            <if test="request.content != null and request.content != ''">
                content = #{request.content},
            </if>
            <if test="request.price != null">
                price = #{request.price},
            </if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE session_id = #{sessionId}
          AND is_deleted = 0
    </update>

    <!-- 세션에 신청자가 있는지 확인 -->
    <select id="hasActiveApplications" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM training_course_application
            WHERE session_id = #{sessionId}
              AND is_deleted = 0
              AND status != 'CANCELLED'
        )
    </select>

    <!-- 세션 삭제 (Soft Delete) -->
    <update id="deleteSession">
        UPDATE training_session
        SET is_deleted = 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE session_id = #{sessionId}
          AND is_deleted = 0
    </update>

    <!-- 세션 ID로 조회 -->
    <select id="findById" parameterType="long" resultMap="trainingSessionResultMap">
        SELECT session_id,
               course_id,
               session_no,
               session_date,
               start_time,
               end_time,
               location_detail,
               status,
               max_students,
               content,
               price,
               created_at,
               updated_at
        FROM training_session
        WHERE session_id = #{sessionId}
          AND is_deleted = 0
    </select>

    <!-- 결제 완료된 신청 확인 -->
    <select id="hasPaidApplications" resultType="Boolean">
        SELECT EXISTS(
            SELECT 1
            FROM training_course_application tca
                     INNER JOIN order_item oi ON tca.application_id = oi.application_id
                AND oi.is_deleted = 0
                     INNER JOIN order_master om ON oi.order_id = om.order_id
                AND om.is_deleted = 0
            WHERE tca.session_id = #{sessionId}
              AND tca.is_deleted = 0
              AND om.order_status IN ('PAID', 'PARTIAL_REFUNDED')
        )
    </select>

    <!-- 세션 및 연관 데이터 soft delete -->
    <update id="deleteSessionWithRelatedData">
        <!-- 1. 피드백 첨부파일 soft delete -->
        UPDATE feedback_attachment
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE feedback_id IN (
        SELECT feedback_id
        FROM feedback
        WHERE application_id IN (
        SELECT application_id
        FROM training_course_application
        WHERE session_id = #{sessionId}
        AND is_deleted = 0
        )
        AND is_deleted = 0
        )
        AND is_deleted = 0;

        <!-- 2. 피드백 soft delete -->
        UPDATE feedback
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE application_id IN (
        SELECT application_id
        FROM training_course_application
        WHERE session_id = #{sessionId}
        AND is_deleted = 0
        )
        AND is_deleted = 0;

        <!-- 3. 출석 정보 soft delete -->
        UPDATE training_attendance
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE application_id IN (
        SELECT application_id
        FROM training_course_application
        WHERE session_id = #{sessionId}
        AND is_deleted = 0
        )
        AND is_deleted = 0;

        <!-- 4. 위시리스트 상세 soft delete -->
        UPDATE wishlist_detail
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE application_id IN (
        SELECT application_id
        FROM training_course_application
        WHERE session_id = #{sessionId}
        AND is_deleted = 0
        )
        AND is_deleted = 0;

        <!-- 5. 대기 soft delete -->
        UPDATE waiting
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE application_id IN (
        SELECT application_id
        FROM training_course_application
        WHERE session_id = #{sessionId}
        AND is_deleted = 0
        )
        AND is_deleted = 0;

        <!-- 6. 신청 정보 soft delete -->
        UPDATE training_course_application
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE session_id = #{sessionId}
        AND is_deleted = 0;

        <!-- 7. 세션 공지사항 soft delete -->
        UPDATE training_course_notice
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE session_id = #{sessionId}
        AND is_deleted = 0;

        <!-- 8. 세션 변경 이력 soft delete -->
        UPDATE training_session_change
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE session_id = #{sessionId}
        AND is_deleted = 0;

        <!-- 9. 세션 soft delete -->
        UPDATE training_session
        SET is_deleted = 1,
        deleted_at = NOW(),
        updated_by = #{deletedBy},
        updated_at = NOW()
        WHERE session_id = #{sessionId}
        AND is_deleted = 0;
    </update>

</mapper>