<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mungtrainer.mtserver.training.dao.TrainingCourseDao">

    <select id="findByCourseId" parameterType="long" resultType="com.mungtrainer.mtserver.training.entity.TrainingCourse">
        SELECT *
        FROM training_course
        WHERE course_id = #{courseId}
    </select>

    <!-- 훈련과정 검색 (무한 스크롤 - 커서 기반) -->
    <select id="searchCourses" resultType="com.mungtrainer.mtserver.training.dto.response.CourseSearchItemDto">
        SELECT
            tc.course_id AS courseId,
            tc.trainer_id AS trainerId,
            u.name AS trainerName,
            tc.title,
            tc.description,
            tc.tags,
            tc.main_image AS mainImage,
            tc.lesson_form AS lessonForm,
            tc.difficulty,
            tc.location,
            tc.type,
            MIN(ts.price) AS price
        FROM training_course tc
        INNER JOIN user u ON tc.trainer_id = u.user_id AND u.is_deleted = 0
        LEFT JOIN training_session ts ON tc.course_id = ts.course_id AND ts.is_deleted = 0
        WHERE tc.is_deleted = 0
        <if test="request.keyword != null and request.keyword != ''">
            AND tc.title LIKE CONCAT('%', #{request.keyword}, '%')
        </if>
        <if test="request.lastCourseId != null">
            AND tc.course_id &lt; #{request.lastCourseId}
        </if>
        GROUP BY tc.course_id, tc.trainer_id, u.name, tc.title, tc.description, tc.tags,
                 tc.main_image, tc.lesson_form, tc.difficulty, tc.location, tc.type
        ORDER BY tc.course_id DESC
        LIMIT #{request.size}
    </select>

</mapper>