<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mungtrainer.mtserver.counseling.dao.TrainerUserDAO">


    <!-- =======================
         ResultMap 정의
         ======================= -->
    <resultMap id="MultiCourseWithSessions" type="com.mungtrainer.mtserver.counseling.dto.response.MultiCourseGroupResponse">
        <id property="courseId" column="courseId"/>
        <result property="title" column="title"/>
        <result property="tags" column="tags"/>
        <result property="description" column="description"/>
        <result property="location" column="location"/>
        <result property="type" column="type"/>
        <result property="difficulty" column="difficulty"/>
        <result property="mainImage" column="mainImage"/>
        <result property="totalSessions" column="totalSessions"/>
        <result property="attendedSessions" column="attendedSessions"/>
        <result property="attendanceRate" column="attendanceRate"/>

        <!-- 세션 리스트 매핑 -->
        <collection property="sessions" ofType="com.mungtrainer.mtserver.counseling.dto.response.MultiSessionResponse">
            <id property="sessionId" column="sessionId"/>
            <result property="sessionNo" column="sessionNo"/>
            <result property="sessionDate" column="sessionDate"/>
            <result property="startTime" column="startTime"/>
            <result property="endTime" column="endTime"/>
            <result property="locationDetail" column="locationDetail"/>
            <result property="attendanceStatus" column="attendanceStatus"/>
        </collection>
    </resultMap>


    <!-- 유저 ID로 연결된 훈련사 ID 조회 -->
    <select id="findTrainerIdByUserId" resultType="java.lang.Long">
        SELECT trainer_id
        FROM trainer_user
        WHERE user_id = #{userId}
        AND is_deleted = 0
        LIMIT 1
    </select>

    <!-- 훈련사와 사용자 관계 존재 여부 확인 -->
    <select id="existsTrainerUserRelation" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM trainer_user
            WHERE trainer_id = #{trainerId}
            AND user_id = #{userId}
            AND is_deleted = 0
        )
    </select>
<!--     dog Id 로 훈련사 조회-->
    <select id="findTrainerIdByDogId" resultType="java.lang.Long">
        SELECT tu.trainer_id
        FROM dog d
        JOIN trainer_user tu
        ON d.user_id = tu.user_id
        WHERE d.dog_id = #{dogId}
        AND d.is_deleted = 0
        AND tu.is_deleted = 0
        LIMIT 1;
    </select>

    <!-- 훈련사가 관리하는 회원 목록 조회 -->
    <select id="findUsersByTrainerId"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.TrainerUserListResponse">
        SELECT
            u.user_id AS userId,
            u.name AS name,
            u.phone AS phone,
            u.email AS email,
            u.profile_image AS profileImage
        FROM trainer_user tu
        JOIN user u ON tu.user_id = u.user_id
        WHERE tu.trainer_id = #{trainerId}
          AND tu.is_deleted = 0
          AND u.is_deleted = 0
        ORDER BY u.created_at DESC
    </select>

<!--    특정 반려견이 신청한 과정 중 같은 tags 기준으로 몇 회차 들었는지 조회-->
    <select id="findTrainingApplicationsByDogId"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.TrainingApplicationResponse">
        SELECT
            c.course_id,
            c.title AS course_title,
            c.description AS course_description,
            c.tags,
            c.type,
            c.difficulty,

            s.session_id,
            s.session_date,
            s.start_time AS session_start_time,
            s.end_time AS session_end_time,

            COUNT(a.application_id) OVER (PARTITION BY c.tags) AS times_applied,

            attended.attended_count,

            ta.`status` AS attendance_status

        FROM training_course c
        JOIN training_session s ON s.course_id = c.course_id
        JOIN training_course_application a ON a.session_id = s.session_id
        LEFT JOIN training_attendance ta
            ON ta.application_id = a.application_id
            AND ta.is_deleted = 0

<!--    ATTENDED 개수를 course.tags 기준으로 미리 group by 해서 가져오기 (dogId 조건 추가) -->
        LEFT JOIN (
            SELECT
                c2.tags,
                COUNT(ta2.attendance_id) AS attended_count
            FROM training_course c2
            JOIN training_session s2 ON s2.course_id = c2.course_id
            JOIN training_course_application a2 ON a2.session_id = s2.session_id
            JOIN training_attendance ta2 ON ta2.application_id = a2.application_id
            WHERE ta2.status = 'ATTENDED'
              AND a2.dog_id = #{dogId}
              AND a2.is_deleted = 0
              AND c2.is_deleted = 0
            GROUP BY c2.tags
        ) attended ON attended.tags = c.tags

        WHERE a.dog_id = #{dogId}
          AND c.is_deleted = 0
          AND a.is_deleted = 0
          AND c.type != 'MULTI'

        ORDER BY c.tags, s.session_date;
    </select>

<!--    신청한 다회차(MULTI) course 목록-->
    <select id="findMultiCoursesByDogId"
            parameterType="long"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.MultiCourseGroupResponse">

        SELECT DISTINCT
        tc.course_id AS courseId,
        tc.title,
        tc.tags,
        tc.description,
        tc.location,
        tc.type,
        tc.difficulty,
        tc.main_image AS mainImage
        FROM training_course tc
        JOIN training_session ts
        ON tc.course_id = ts.course_id
        JOIN training_course_application tca
        ON ts.session_id = tca.session_id
        WHERE tca.dog_id = #{dogId}
        AND tc.type = 'MULTI'
        AND tc.is_deleted = 0
    </select>

    <select id="findSessionsWithAttendance"
            parameterType="map"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.MultiSessionResponse">

        SELECT
        ts.session_id AS sessionId,
        ts.session_no AS sessionNo,
        ts.session_date AS sessionDate,
        ts.start_time AS startTime,
        ts.end_time AS endTime,
        ts.location_detail AS locationDetail,
        ta.status AS attendanceStatus
        FROM training_session ts
        LEFT JOIN training_course_application tca
        ON ts.session_id = tca.session_id
        AND tca.dog_id = #{dogId}
        LEFT JOIN training_attendance ta
        ON tca.application_id = ta.application_id
        WHERE ts.course_id = #{courseId}
        ORDER BY ts.session_no

    </select>


    <!-- =======================
        다회차 과정 + 세션 + 출석
        ======================= -->
    <select id="findMultiCourseDetail"
            parameterType="map"
            resultMap="MultiCourseWithSessions">

        SELECT
        tc.course_id AS courseId,
        tc.title,
        tc.tags,
        tc.description,
        tc.location,
        tc.type,
        tc.difficulty,
        tc.main_image AS mainImage,
        ts.session_id AS sessionId,
        ts.session_no AS sessionNo,
        ts.session_date AS sessionDate,
        ts.start_time AS startTime,
        ts.end_time AS endTime,
        ts.location_detail AS locationDetail,
        ta.status AS attendanceStatus,
        sub.totalSessions AS totalSessions,
        sub.attendedSessions AS attendedSessions,
        (CASE WHEN sub.totalSessions = 0 THEN 0 ELSE sub.attendedSessions * 100.0 / sub.totalSessions END) AS attendanceRate
        FROM training_course tc
        JOIN training_session ts ON tc.course_id = ts.course_id
        JOIN training_course_application tca
        ON ts.session_id = tca.session_id
        AND tca.dog_id = #{dogId}
        LEFT JOIN training_attendance ta ON ta.application_id = tca.application_id
        LEFT JOIN (
            SELECT
                ts2.course_id,
                COUNT(DISTINCT ts2.session_id) AS totalSessions,
                COUNT(DISTINCT CASE WHEN ta2.status = 'ATTENDED' THEN ts2.session_id END) AS attendedSessions
            FROM training_session ts2
            JOIN training_course_application tca2
                ON ts2.session_id = tca2.session_id
                AND tca2.dog_id = #{dogId}
            LEFT JOIN training_attendance ta2 ON tca2.application_id = ta2.application_id
            GROUP BY ts2.course_id
        ) sub ON sub.course_id = tc.course_id
        WHERE tc.type = 'MULTI'
        AND tc.is_deleted = 0
        ORDER BY tc.course_id, ts.session_no
    </select>




    <!--    출석률 계산용 count 쿼리-->
<!--    총 회차 수-->
    <select id="countSessionsByCourseId"
            parameterType="long"
            resultType="int">
        SELECT COUNT(*)
        FROM training_session
        WHERE course_id = #{courseId}
    </select>

<!--    출석한 회차 수-->
    <select id="countAttendedSessions"
            parameterType="map"
            resultType="int">

        SELECT COUNT(*)
        FROM training_attendance ta
        JOIN training_course_application tca
            ON ta.application_id = tca.application_id
        JOIN training_session ts
            ON tca.session_id = ts.session_id
        WHERE tca.dog_id = #{dogId}
          AND ts.course_id = #{courseId}
          AND ta.status = 'ATTENDED'
    </select>


<!--    승인 대기 목록 (특정 훈련사의 과정만 조회)-->
    <!--    APPLIED, WAITING만 포함 (상담 완료 후 상태) -->
    <select id="selectWaitingApplications" resultType="com.mungtrainer.mtserver.counseling.dto.response.AppliedWaitingResponse">
        SELECT
            tca.application_id AS applicationId,
            d.name AS dogName,
            u.name AS ownerName,
            u.user_id AS userId,
            u.fcm_token AS fcmToken,
            tc.title AS courseTitle,
            ts.session_date AS sessionDate,
            ts.start_time AS startTime,
            ts.end_time AS endTime,
            tca.status AS status,
            -- WAITING 상태 추가 정보
            CASE WHEN tca.status = 'WAITING' THEN 1 ELSE 0 END AS isWaiting,
            COALESCE(w.is_approved, 0) AS isPreApproved,
            -- 대기 순번 계산 (같은 세션 내에서 created_at 기준 순서)
            CASE WHEN tca.status = 'WAITING' THEN
                (SELECT COUNT(*) + 1
                 FROM training_course_application tca2
                 WHERE tca2.session_id = tca.session_id
                 AND tca2.status = 'WAITING'
                 AND tca2.created_at &lt; tca.created_at
                 AND tca2.is_deleted = 0)
            ELSE NULL END AS waitingOrder
        FROM training_course_application tca
        JOIN dog d ON tca.dog_id = d.dog_id
        JOIN user u ON d.user_id = u.user_id
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        LEFT JOIN waiting w ON tca.application_id = w.application_id AND w.is_deleted = 0
        WHERE tca.status IN ('APPLIED', 'WAITING')
        AND tc.trainer_id = #{trainerId}
        -- 미리 승인된 대기자는 목록에서 제외
        AND NOT (tca.status = 'WAITING' AND COALESCE(w.is_approved, 0) = 1)
        AND tca.is_deleted = 0
        AND d.is_deleted = 0
        AND u.is_deleted = 0
        AND ts.is_deleted = 0
        AND tc.is_deleted = 0
        ORDER BY ts.session_date, ts.start_time, tca.created_at;
    </select>

<!--    코스별로 그룹핑된 승인 대기 목록 조회 (다회차 일괄 승인용)-->
    <resultMap id="GroupedApplicationMap" type="com.mungtrainer.mtserver.counseling.dto.response.GroupedApplicationResponse">
        <result property="courseId" column="courseId"/>
        <result property="courseTitle" column="courseTitle"/>
        <result property="courseType" column="courseType"/>
        <result property="dogId" column="dogId"/>
        <result property="userId" column="userId"/>
        <result property="fcmToken" column="fcmToken"/>
        <result property="dogName" column="dogName"/>
        <result property="ownerName" column="ownerName"/>
        <result property="totalSessions" column="totalSessions"/>
        <collection property="sessions" ofType="com.mungtrainer.mtserver.counseling.dto.response.GroupedApplicationResponse$SessionInfo">
            <result property="applicationId" column="applicationId"/>
            <result property="sessionId" column="sessionId"/>
            <result property="sessionNo" column="sessionNo"/>
            <result property="sessionDate" column="sessionDate"/>
            <result property="startTime" column="startTime"/>
            <result property="endTime" column="endTime"/>
            <result property="status" column="status"/>
        </collection>
    </resultMap>

    <select id="selectGroupedWaitingApplications" resultMap="GroupedApplicationMap">
        SELECT
            tc.course_id AS courseId,
            tc.title AS courseTitle,
            tc.type AS courseType,
            d.dog_id AS dogId,
            d.name AS dogName,
            u.name AS ownerName,
            u.user_id AS userId,
            u.fcm_token AS fcmToken,
            (SELECT COUNT(DISTINCT ts2.session_id)
             FROM training_session ts2
             WHERE ts2.course_id = tc.course_id
             AND ts2.is_deleted = 0) AS totalSessions,
            tca.application_id AS applicationId,
            ts.session_id AS sessionId,
            ts.session_no AS sessionNo,
            ts.session_date AS sessionDate,
            ts.start_time AS startTime,
            ts.end_time AS endTime,
            tca.status AS status,
            -- WAITING 상태 추가 정보
            CASE WHEN tca.status = 'WAITING' THEN 1 ELSE 0 END AS isWaiting,
            COALESCE(w.is_approved, 0) AS isPreApproved,
            CASE WHEN tca.status = 'WAITING' THEN
                (SELECT COUNT(*) + 1
                 FROM training_course_application tca2
                 WHERE tca2.session_id = tca.session_id
                 AND tca2.status = 'WAITING'
                 AND tca2.created_at &lt; tca.created_at
                 AND tca2.is_deleted = 0)
            ELSE NULL END AS waitingOrder
        FROM training_course_application tca
        JOIN dog d ON tca.dog_id = d.dog_id
        JOIN user u ON d.user_id = u.user_id
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        LEFT JOIN waiting w ON tca.application_id = w.application_id AND w.is_deleted = 0
        WHERE tca.status IN ('APPLIED', 'WAITING')
        AND tc.trainer_id = #{trainerId}
        -- 미리 승인된 대기자는 목록에서 제외
        AND NOT (tca.status = 'WAITING' AND COALESCE(w.is_approved, 0) = 1)
        AND tca.is_deleted = 0
        AND d.is_deleted = 0
        AND u.is_deleted = 0
        AND ts.is_deleted = 0
        AND tc.is_deleted = 0
        ORDER BY tc.course_id, d.dog_id, ts.session_date, ts.start_time, tca.created_at;
    </select>

<!--    신청 반려견 상세 정보 조회 (훈련사용 - 승인 대기 모달)-->
    <select id="selectApplicationDogDetail" resultType="com.mungtrainer.mtserver.counseling.dto.response.ApplicationDogDetailResponse">
        SELECT
            d.dog_id AS dogId,
            d.name AS name,
            d.profile_image AS profileImageUrl,
            d.age AS age,
            d.gender AS gender,
            d.breed AS breed,
            u.name AS ownerName,
            u.phone AS ownerPhone
        FROM training_course_application tca
        JOIN dog d ON tca.dog_id = d.dog_id
        JOIN user u ON d.user_id = u.user_id
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        WHERE tca.application_id = #{applicationId}
        AND tc.trainer_id = #{trainerId}
        AND tca.is_deleted = 0
        AND d.is_deleted = 0
        AND u.is_deleted = 0
        LIMIT 1;
    </select>

<!--    승인, 거절(거절사유)-->
<!--    승인 (상담 완료 후에만 가능: APPLIED, WAITING)-->
    <update id="updateStatusApproved">
        UPDATE training_course_application
        SET
        status = 'ACCEPT',
        updated_by = #{trainerId},
        updated_at = NOW()
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
        AND status IN ('APPLIED', 'WAITING');
    </update>


    <!--    거절 (상담 완료 후에만 가능: APPLIED, WAITING)-->
    <update id="updateStatusRejected">
        UPDATE training_course_application
        SET
        status = 'REJECTED',
        reject_reason = #{rejectReason},
        updated_by = #{trainerId},
        updated_at = NOW()
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
        AND status IN ('APPLIED', 'WAITING');
    </update>

<!--    일괄 승인 (코스의 모든 회차) - APPLIED만 ACCEPT로 변경-->
    <update id="updateBulkStatusApproved">
        UPDATE training_course_application tca
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        SET
            tca.status = 'ACCEPT',
            tca.updated_by = #{trainerId},
            tca.updated_at = NOW()
        WHERE tc.course_id = #{courseId}
        AND tca.dog_id = #{dogId}
        AND tc.trainer_id = #{trainerId}
        AND tca.status = 'APPLIED'
        AND tca.is_deleted = 0;
    </update>

<!--    일괄 거절 (코스의 모든 회차) - 상담 완료 후에만 가능-->
    <update id="updateBulkStatusRejected">
        UPDATE training_course_application tca
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        SET
            tca.status = 'REJECTED',
            tca.reject_reason = #{rejectReason},
            tca.updated_by = #{trainerId},
            tca.updated_at = NOW()
        WHERE tc.course_id = #{courseId}
        AND tca.dog_id = #{dogId}
        AND tc.trainer_id = #{trainerId}
        AND tca.status IN ('APPLIED', 'WAITING')
        AND tca.is_deleted = 0;
    </update>

    <!-- 코스와 반려견으로 신청 ID 목록 조회 -->
    <select id="findApplicationIdsByCourseAndDog" resultType="java.lang.Long">
        SELECT tca.application_id
        FROM training_course_application tca
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        WHERE tc.course_id = #{courseId}
        AND tca.dog_id = #{dogId}
        AND tca.status = 'ACCEPT'
        AND tca.is_deleted = 0
        ORDER BY ts.session_date, ts.start_time
    </select>

    <!-- 코스와 반려견으로 WAITING 상태 신청 ID 목록 조회 -->
    <select id="findWaitingApplicationIdsByCourseAndDog" resultType="java.lang.Long">
        SELECT tca.application_id
        FROM training_course_application tca
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        WHERE tc.course_id = #{courseId}
        AND tca.dog_id = #{dogId}
        AND tca.status = 'WAITING'
        AND tca.is_deleted = 0
        ORDER BY ts.session_date, ts.start_time
    </select>

    <!-- ========================================
     대기 로직 개선을 위한 쿼리 추가
     ======================================== -->

    <!-- 신청 ID로 사용자 ID 조회 -->
    <select id="findUserIdByApplicationId" resultType="long">
        SELECT d.user_id
        FROM training_course_application tca
        INNER JOIN dog d ON tca.dog_id = d.dog_id
        WHERE tca.application_id = #{applicationId}
        AND tca.is_deleted = 0
    </select>

    <!-- 신청 ID로 세션 ID 조회 -->
    <select id="findSessionIdByApplicationId" resultType="long">
        SELECT session_id
        FROM training_course_application
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
    </select>

    <!-- 신청 상태 조회 -->
    <select id="findApplicationStatus" resultType="string">
        SELECT status
        FROM training_course_application
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
    </select>

    <!-- 세션 조회 -->
    <select id="findSessionById" resultType="com.mungtrainer.mtserver.training.entity.TrainingSession">
        SELECT session_id,
        course_id,
        session_no,
        session_date,
        start_time,
        end_time,
        location_detail,
        status,
        max_students,
        content,
        price,
        is_deleted,
        created_by,
        created_at,
        updated_by,
        updated_at
        FROM training_session
        WHERE session_id = #{sessionId}
        AND is_deleted = 0
    </select>

    <!-- 세션 조회 (비관적 락) -->
    <!-- SELECT FOR UPDATE: 행 레벨 락을 획득하여 다른 트랜잭션의 동시 접근 차단 -->
    <!-- 대기자 승격 시 정원 확인의 동시성 문제 해결 -->
    <select id="findSessionByIdForUpdate" resultType="com.mungtrainer.mtserver.training.entity.TrainingSession">
        SELECT session_id,
        course_id,
        session_no,
        session_date,
        start_time,
        end_time,
        location_detail,
        status,
        max_students,
        content,
        price,
        is_deleted,
        created_by,
        created_at,
        updated_by,
        updated_at
        FROM training_session
        WHERE session_id = #{sessionId}
        AND is_deleted = 0
        FOR UPDATE
    </select>

    <!-- 승인된 신청 수 카운트 (ACCEPT, PAID만) -->
    <select id="countApprovedApplications" resultType="int">
        SELECT COUNT(*)
        FROM training_course_application
        WHERE session_id = #{sessionId}
        AND status IN ('ACCEPT', 'PAID')
        AND is_deleted = 0
    </select>

    <!-- 가장 오래 대기한 신청 ID 조회 (FIFO) -->
    <select id="findOldestWaitingApplicationId" resultType="long">
        SELECT w.application_id
        FROM waiting w
        INNER JOIN training_course_application tca
        ON w.application_id = tca.application_id
        WHERE tca.session_id = #{sessionId}
        AND w.status = 'WAITING'
        AND w.is_deleted = 0
        ORDER BY w.created_at ASC
        LIMIT 1
    </select>

    <!-- 신청 상태 단순 업데이트
     주의: 이미 EXPIRED나 CANCELLED 상태인 신청은 다시 변경되지 않도록
     현재 상태가 WAITING 또는 APPLIED인 경우에만 업데이트합니다. -->
    <update id="updateApplicationStatusSimple">
        UPDATE training_course_application
        SET status = #{status},
        updated_at = NOW()
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
    </update>

    <!-- 대기 상태 업데이트 -->
    <update id="updateWaitingStatus">
        UPDATE waiting
        SET status = #{status},
        updated_at = NOW()
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
    </update>

    <!-- 대기 중인 신청 미리 승인 -->
    <update id="approveWaitingApplication">
        UPDATE waiting
        SET is_approved = 1,
        updated_at = NOW()
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
    </update>

    <!-- 대기 테이블 등록 -->
    <insert id="insertWaiting">
        INSERT INTO waiting (
        application_id,
        status,
        created_by,
        updated_by,
        created_at,
        updated_at,
        is_deleted
        ) VALUES (
        #{applicationId},
        'WAITING',
        #{userId},
        #{userId},
        NOW(),
        NOW(),
        0
        )
    </insert>

    <!-- ========================================
         결제 기한 관리용 쿼리 (선택 기능)
         ======================================== -->

    <!-- 결제 기한 설정 -->
    <update id="updatePaymentDeadline">
        UPDATE training_course_application
        SET payment_deadline = DATE_ADD(NOW(), INTERVAL #{hours} HOUR),
            updated_at = NOW()
        WHERE application_id = #{applicationId}
          AND is_deleted = 0
    </update>

    <!-- 결제 기한이 지난 ACCEPT 상태 신청 조회 -->
    <select id="findExpiredAcceptApplications" resultType="long">
        <![CDATA[
        SELECT application_id
        FROM training_course_application
        WHERE status = 'ACCEPT'
          AND payment_deadline IS NOT NULL
          AND payment_deadline < NOW()
          AND is_deleted = 0
        ORDER BY payment_deadline ASC
        ]]>
    </select>

    <!-- 신청을 만료 처리 -->
    <update id="expireApplication">
        UPDATE training_course_application
        SET status = 'EXPIRED',
            updated_at = NOW(),
            updated_by = 0  -- 시스템 자동 처리
        WHERE application_id = #{applicationId}
          AND status = 'ACCEPT'
          AND is_deleted = 0
    </update>

    <!-- 결제 기한 초기화 -->
    <update id="clearPaymentDeadline">
        UPDATE training_course_application
        SET payment_deadline = NULL,
            updated_at = NOW()
        WHERE application_id = #{applicationId}
          AND is_deleted = 0
    </update>

</mapper>